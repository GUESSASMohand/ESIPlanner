<!DOCTYPE html>
<html>
<head>
    <title>Basic usage</title>
    <meta charset="utf-8">
    <link href="styles/kendo.common.min.css" rel="stylesheet">
    <link href="styles/kendo.default.min.css" rel="stylesheet">
    <link href="styles/kendo.Material.min.css" rel="stylesheet">

    <script src="js/jquery.min.js"></script>
    <script src="js/kendo.all.min.js"></script>


</head>
<body>
<div id="scheduler"></div>
</div>


<script>
    $(function() {
        $("#scheduler").kendoScheduler({
            date :new Date ("2018/02/11") ,
            height:642,
            showWorkHours:true,
            workDayStart: new Date("2018/1/1 8:30 AM"),
            workDayEnd: new Date("2018/1/1 5:30 PM"),
            workWeekStart:0,
            workWeekEnd:4,

            views: [
                "day",
                { type: "week", selected: true },
                "workWeek",
                "month",
                "agenda"
            ],
            dataSource : [
                {
                    id:1,
                    title:"POO Cour - A1 - Sadeg",
                    start: new Date ("2018/02/11 08:30 AM"),
                    end: new Date ("2018/02/11 10:30 AM"),
                    attendee:2,
                    roomId:1
                },
                {
                    id:2,
                    title:"LOGM TD - S11 - Meziani",
                    start: new Date ("2018/02/11 01:00 PM"),
                    end: new Date ("2018/02/11 03:00 PM"),
                    attendee:2,
                    roomId:6

                }
            ],
            resources : [
                {
                    field : "attendee",
                    dataSource : [
                        {value :1 , text :"Sadeg"},
                        {value :2 , text :"2CPI_G6"},
                        {value :3 , text :"Meziani"},
                        {value :4 , text :"2CPI_G6"},
                    ],
                    title: "Attendee",


                },

                {
                    field : "roomId",
                    dataSource : [
                        {value :1 , text :"A1"},
                        {value :2 , text :"A2"},
                        {value :3 , text :"A3"},
                        {value :4 , text :"A4"},
                        {value :5 , text :"S1"},
                        {value :6 , text :"S11"}
                    ],
                    title: "Room",
                    name :"room"

                }

            ],


            /*group : {
                resources: ["Salle"],
                orientation: "vertical",
            },*/


            resize: function(e) {
                if (roomIsOccupied(e.start, e.end, e.event, e.resources) || attendeeIsOccupied(e.start, e.end, e.event, e.resources)) {
                    this.wrapper.find(".k-marquee-color").addClass("invalid-slot");
                    e.preventDefault();
                }
            },
            resizeEnd: function(e) {
                if (!checkAvailability(e.start, e.end, e.events)) {
                    e.preventDefault();
                }
            },
            move: function(e) {
                if (roomIsOccupied(e.start, e.end, e.event, e.resources) || attendeeIsOccupied(e.start, e.end, e.event, e.resources)) {
                    this.wrapper.find(".k-event-drag-hint").addClass("invalid-slot");
                }
            },
            moveEnd: function(e) {
                if (!checkAvailability(e.start, e.end, e.event, e.resources)) {
                    e.preventDefault();
                }
            },
            add: function(e) {
                if (!checkAvailability(e.event.start, e.event.end, e.event)) {
                    e.preventDefault();
                }
            },
            save: function(e) {
                if (!checkAvailability(e.event.start, e.event.end, e.event)) {
                    e.preventDefault();
                }
            },

        });


        function occurrencesInRangeByResource(start, end, resourceFieldName, event, resources) {
            var scheduler = $("#scheduler").getKendoScheduler();

            var occurrences = scheduler.occurrencesInRange(start, end);

            var idx = occurrences.indexOf(event);
            if (idx > -1) {
                occurrences.splice(idx, 1);
            }

            event = $.extend({}, event, resources);

            return filterByResource(occurrences, resourceFieldName, event[resourceFieldName]);
        }

        function filterByResource(occurrences, resourceFieldName, value) {
            var result = [];
            var occurrence;

            for(var idx = 0, length = occurrences.length; idx < length; idx++) {
                occurrence = occurrences[idx];
                if (occurrence[resourceFieldName] === value) {
                    result.push(occurrence);
                }
            }
            return result;
        }

        function attendeeIsOccupied(start, end, event, resources) {
            var occurrences = occurrencesInRangeByResource(start, end, "attendee", event, resources);
            if (occurrences.length > 0) {
                return true;
            }
            return false;
        }

        function roomIsOccupied(start, end, event, resources) {
            var occurrences = occurrencesInRangeByResource(start, end, "roomId", event, resources);
            if (occurrences.length > 0) {
                return true;
            }
            return false;
        }

        function checkAvailability(start, end, event, resources) {

            if (attendeeIsOccupied(start, end, event, resources)) {
                setTimeout(function() {
                    alert("This person is not available in this time period.");
                }, 0);

                return false;
            }

            if (roomIsOccupied(start, end, event, resources)) {
                setTimeout(function() {
                    alert("This room is not available in this time period.");
                }, 0);

                return false;
            }

            return true;
        }


    });

</script>

<style>
    .invalid-slot {
        background: red !important;
        cursor: no-drop;
    }
</style>


</body>
</html>
